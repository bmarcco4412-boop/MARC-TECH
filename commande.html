<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mes Commandes - PAY FUSION</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        :root {
            --blue-prof: #2563eb; --blue-light: #3b82f6; --white: #ffffff;
            --gray-100: #f8fafc; --gray-200: #e2e8f0; --gray-700: #334155;
            --success: #10b981; --error: #ef4444; --warning: #f59e0b;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Inter', sans-serif; font-size: 0.875rem; color: var(--gray-700); background-color: var(--gray-100); line-height: 1.6; }
        
        /* HEADER */
        header { height: 70px; background: var(--white); border-bottom: 1px solid var(--gray-200); display: flex; align-items: center; justify-content: center; position: sticky; top: 0; z-index: 1000; }
        .logo-center { position: absolute; left: 50%; transform: translateX(-50%); }
        .logo-center img { height: 35px; }
        .btn-back { position: absolute; left: 1.5rem; color: var(--gray-700); text-decoration: none; font-weight: 600; }

        .container { max-width: 800px; margin: 2rem auto; padding: 0 1rem; }
        .pf-card { background: var(--white); border: 1px solid var(--gray-200); border-radius: 16px; padding: 1.5rem; box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
        
        .pf-table { width: 100%; border-collapse: collapse; margin-top: 1rem; }
        .pf-table th { text-align: left; padding: 1rem; font-size: 0.7rem; text-transform: uppercase; opacity: 0.5; border-bottom: 2px solid var(--gray-100); }
        .pf-table td { padding: 1rem; border-bottom: 1px solid var(--gray-100); font-size: 0.85rem; }

        .badge { padding: 4px 10px; border-radius: 20px; font-size: 0.7rem; font-weight: 700; text-transform: uppercase; }
        .badge-pending { background: #fff7ed; color: #9a3412; }
        .badge-completed { background: #ecfdf5; color: #065f46; }
        .badge-cancelled { background: #fef2f2; color: #991b1b; }

        .empty-state { text-align: center; padding: 4rem 1rem; opacity: 0.5; }
        .pf-ascii { font-family: monospace; }
    </style>
</head>
<body>

    <header>
        <a href="home.html" class="btn-back"><span class="pf-ascii"><</span> Retour</a>
        <div class="logo-center"><img src="assets/logos/placeholder.png" alt="PAY FUSION"></div>
    </header>

    <div class="container">
        <h2 style="margin-bottom: 1.5rem;"><span class="pf-ascii">●</span> Historique de mes commandes</h2>
        
        <div class="pf-card">
            <div style="overflow-x: auto;">
                <table class="pf-table" id="table-orders" style="display:none;">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Service</th>
                            <th>Montant</th>
                            <th>Statut</th>
                        </tr>
                    </thead>
                    <tbody id="order-rows"></tbody>
                </table>

                <div id="empty-msg" class="empty-state">
                    <i class="fa-solid fa-folder-open" style="font-size: 2.5rem; margin-bottom: 1rem; display: block;"></i>
                    Aucune commande trouvée.
                </div>
            </div>
        </div>
    </div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import { getFirestore, collection, query, where, orderBy, onSnapshot } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyAasc7D2uajiC0NUdCsy6Aiy-PftWqlnYg",
        authDomain: "pay-fusion-27319.firebaseapp.com",
        projectId: "pay-fusion-27319",
        storageBucket: "pay-fusion-27319.firebasestorage.app",
        messagingSenderId: "428975862756",
        appId: "1:428975862756:web:65e4117598257b1cae8df1"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    onAuthStateChanged(auth, (user) => {
        if (user) {
            fetchUserOrders(user.uid);
        } else {
            window.location.href = 'login.html';
        }
    });

    function fetchUserOrders(uid) {
        // IMPORTANT: Firestore nécessite un INDEX pour orderBy("createdAt"). 
        // Si le tableau reste vide, regarde la console (F12) pour cliquer sur le lien de création d'index.
        const q = query(
            collection(db, "orders"),
            where("userId", "==", uid),
            orderBy("createdAt", "desc")
        );

        onSnapshot(q, (snapshot) => {
            const table = document.getElementById('table-orders');
            const tbody = document.getElementById('order-rows');
            const empty = document.getElementById('empty-msg');

            if (snapshot.empty) {
                table.style.display = 'none';
                empty.style.display = 'block';
                return;
            }

            empty.style.display = 'none';
            table.style.display = 'table';
            
            let html = '';
            snapshot.forEach(d => {
                const o = d.data();
                const date = o.createdAt ? new Date(o.createdAt.seconds * 1000).toLocaleDateString('fr-FR') : '---';
                html += `
                    <tr>
                        <td>${date}</td>
                        <td><span style="font-weight:700">${o.serviceName}</span><br><small>${o.details || o.userIdentifier || ''}</small></td>
                        <td style="font-weight:800; color:var(--blue-prof)">${o.totalHTG.toLocaleString()} HTG</td>
                        <td><span class="badge badge-${o.status}">${o.status}</span></td>
                    </tr>
                `;
            });
            tbody.innerHTML = html;
        });
    }
</script>
</body>
</html>